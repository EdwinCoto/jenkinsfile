
// global variables
buildInfo

pipeline {
    agent none

    stages {

        stage('Builder Block') {
            agent { label 'mp' }    // 1 executor allocated here
            stages {

                stage('Build') {
                    steps {
                        echo "--- BUILD ---"
                        sh "ls -lrta ; pwd"
                    }
                }

                stage('Test') {
                    steps {
                        echo "--- TEST ---"
                        sh "echo 'demo' > demo.txt"
                    }
                }

                stage('Package') {
                    steps {
                        echo "--- PACKAGE ---"
                        sh "ls -lrta ; cat demo.txt"
                    }
                }
                
                stage('downstream'){
                    steps{
                        script{
                            def JOB_NAME = "downstream-job"
                            buildInfo = build job  : "${JOB_NAME}", wait: false, propagate: false , waitForStart: true

                            echo ("${buildInfo}")
                            echo ("${buildInfo.number}")
                        }
                    }
                }
            }
        }

        stage('Wait for External Completion') {
            agent none   // IMPORTANT: does NOT use any agent executor
            steps {
                script {
                    timeout(time: 6, unit: 'MINUTES') {
                        waitUntil {
                            def result = Jenkins.instance
                                .getItem("downstream-job")
                                .getBuildByNumber(buildInfo.number)
                                ?.getResult()

                            if (result == null) {
                                echo "Still running..."
                                sleep 30
                                return false
                            } else {
                                echo "External job finished with: ${result}"
                                return true
                            }
                        }
                    }
                }
            }
        }
    }
}
