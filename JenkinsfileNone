
// global variables
buildInfo = ""

pipeline {
    agent none

    stages {

        stage('Builder Block') {
            agent { label 'mp' }    // 1 executor allocated here
            stages {

                stage('Build') {
                    steps {
                        echo "--- BUILD ---"
                        sh "ls -lrta ; pwd"
                    }
                }

                stage('Test') {
                    steps {
                        echo "--- TEST ---"
                        sh "echo 'demo' > demo.txt"
                    }
                }

                stage('Code Analysis'){
                    parallel{

                        stage('Sonar Analysis') {
                            steps {
                                script {
                                    echo "Sonar Scan Started"
                                }
                            }
                        }

                        stage('Vulnerability Scan - Checkmarx') {
                            agent {
                                label 'remote'
                            }
                            steps {
                                script {
                                    echo "Checkmarx Scan Started"
                                }
                            }
                        }
                    }
                }

                stage('Package') {
                    steps {
                        echo "--- PACKAGE ---"
                        sh "ls -lrta ; cat demo.txt"
                    }
                }
                
                stage('downstream'){
                    steps{
                        script{
                            def JOB_NAME = "downstream-job"
                            buildInfo = build job  : "${JOB_NAME}", wait: false, propagate: false , waitForStart: true

                            echo ("${buildInfo.getAbsoluteUrl()}")
                            echo ("${buildInfo.number}")
                        }
                    }
                }
            }
        }

        stage('Wait for External Completion') {
            agent none   // IMPORTANT: does NOT use any agent executor
            steps {
                script {
                    timeout(time: 6, unit: 'MINUTES') {
                        waitUntil {
                            echo("Checking buildInfo.result .........")
                            def result = buildInfo.result
                            
                            /*
                            def result = Jenkins.instance
                                .getItem("downstream-job")
                                .getBuildByNumber(buildInfo.number)
                                ?.getResult()
                            */

                            if (result == null) {
                                echo "Still running..."
                                echo "${result}"
                                sleep 10
                                return false
                            } else {
                                echo "External job finished with: ${result}"
                                return true
                            }
                        }
                    }
                }
            }
        }

        stage("Analize Test Results from Downstream Job") {
            agent { label 'mp' };
                options {
                    skipDefaultCheckout()
                 }
            steps {
                script {

                    def result = buildInfo.result.toString()

                    echo "Downstream job Result: ${result}"

                    try {
                        // Copy artifacts from the downstream job
                        copyArtifacts(
                            projectName: "downstream-job",
                            selector: specific("${buildInfo.number}"),
                            filter: 'demo.txt',
                            target: 'downstream-artifacts/',
                        )

                       /*
                        publishHTML([
                            allowMissing: true,
                            alwaysLinkToLastBuild: true,
                            keepAll: true,
                            reportDir: "${env.WORKSPACE}/downstream-artifacts/automation-project/webdriverio/AWS-Scripts/allure-report/allure-report",
                            reportFiles: 'index.html',
                            reportName: 'Resultados Pruebas Automatizadas'
                        ])
                        */
                    } catch (Exception e) {
                        error("""
                            Las pruebas automatizadas no generaron el reporte de resultados. \nFavor revisar los logs del job de pruebas automatizadas para más detalles."
                            Mensaje de error: ${e}
                            """ )

                    if ( result != 'SUCCESS') {
                        error("""
                            Las pruebas automatizadas no cumplieron con los criterios de aceptación. \nLos resultados de las pruebas se encuentran en el enlace de 'Resultados Pruebas Automatizadas'.
                            """)
                        }
                    }
                }
            }
        }
    }
}
