
// global variables
buildInfo = ""

pipeline {
    agent none

    stages {

        stage('Builder Block') {
            agent { label 'mp' }    // 1 executor allocated here
            stages {

                stage('Build') {
                    steps {
                        echo "--- BUILD ---"
                        sh "ls -lrta ; pwd"
                    }
                }

                stage('Test') {
                    steps {
                        echo "--- TEST ---"
                        sh "echo 'demo' > demo.txt"
                    }
                }

                stage('Package') {
                    steps {
                        echo "--- PACKAGE ---"
                        sh "ls -lrta ; cat demo.txt"
                    }
                }
                
                stage('downstream'){
                    steps{
                        script{
                            def JOB_NAME = "downstream-job"
                            buildInfo = build job  : "${JOB_NAME}", wait: false, propagate: false , waitForStart: true

                            echo ("${buildInfo.getAbsoluteUrl()}")
                            echo ("${buildInfo.number}")
                        }
                    }
                }
            }
        }

        stage('Wait for External Completion') {
            agent none   // IMPORTANT: does NOT use any agent executor
            steps {
                script {
                    timeout(time: 6, unit: 'MINUTES') {
                        waitUntil {
                            echo("Checking buildInfo.result .........")
                            def result = buildInfo.result
                            
                            /*
                            def result = Jenkins.instance
                                .getItem("downstream-job")
                                .getBuildByNumber(buildInfo.number)
                                ?.getResult()
                            */

                            if (result == null) {
                                echo "Still running..."
                                echo "${result}"
                                sleep 30
                                return false
                            } else {
                                echo "External job finished with: ${result}"
                                
                                // Handle different build results
                                switch(result.toString()) {
                                    case 'SUCCESS':
                                        echo "✓ Build completed successfully!"
                                        currentBuild.result = 'SUCCESS'
                                        break
                                    
                                    case 'FAILURE':
                                        echo "✗ Build failed!"
                                        currentBuild.result = 'FAILURE'
                                        error("Downstream job failed. Stopping pipeline.")
                                        break
                                    
                                    case 'ABORTED':
                                        echo "⊗ Build was aborted by user or timeout"
                                        currentBuild.result = 'ABORTED'
                                        error("Downstream job was aborted. Stopping pipeline.")
                                        break
                                    
                                    case 'UNSTABLE':
                                        echo "⚠ Build is unstable (tests failed but build succeeded)"
                                        currentBuild.result = 'UNSTABLE'
                                        // Continue or fail based on your requirements
                                        // error("Downstream job is unstable. Stopping pipeline.")
                                        break
                                    
                                    case 'NOT_BUILT':
                                        echo "○ Build was not executed"
                                        currentBuild.result = 'NOT_BUILT'
                                        error("Downstream job was not built. Stopping pipeline.")
                                        break
                                    
                                    default:
                                        echo "? Unknown build result: ${result}"
                                        currentBuild.result = 'FAILURE'
                                        error("Unknown build result from downstream job: ${result}")
                                        break
                                }

                                return true
                            }
                        }
                    }
                }
            }
        }
    }
}
